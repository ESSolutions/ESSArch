sudo: required
language: python
dist: xenial

cache:
  pip: true
  yarn: true

branches:
  only:
    - master
    - the-big-merge

addons:
  apt:
    packages:
      - libluajit-5.1-dev
      - liblua5.2-dev

templates:
  mariadb: &mariadb DATABASE_URL_ESSARCH="mysql://root@localhost/essarch?isolation_level=read committed"
  mysql: &mysql DATABASE_URL_ESSARCH="mysql://root@localhost/essarch?isolation_level=read committed"
  postgres: &postgres DATABASE_URL_ESSARCH="postgres://postgres@localhost/essarch?isolation_level=read committed"
  mssql: &mssql DATABASE_URL_ESSARCH="mssql://SA:MyPassword42@localhost:1433/essarch?isolation_level=read committed&driver=ODBC Driver 17 for SQL Server"

matrix:
  include:
    - name: 'Linux with SQLite'
      python: '3.7'
      env:
        - REDIS_CLIENT_CLASS="fakeredis.FakeRedis"
        - DJANGO_REDIS_CONNECTION_FACTORY="ESSArch_Core.cache.connection.FakeConnectionFactory"

before_install:
  - sudo mkdir -p /ESSArch/log/
  - sudo chmod 777 /ESSArch/log/
  - python -m pip install --upgrade pip wheel codecov setuptools

  # Pin six to avoid dependency errors,
  # see https://github.com/pypa/pip/issues/4887
  - pip install --upgrade six>=1.12.0
  - pip install -r requirements/tests.txt

install:
  - pip install .

before_script:
  - essarch settings generate -p local_essarch_settings.py

script:
  - coverage run manage.py test -v2

after_success:
  - bash <(curl -s https://codecov.io/bash) -c -F backend
