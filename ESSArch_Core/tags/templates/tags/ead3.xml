{% spaceless %}
<?xml version="1.0" encoding="utf-8"?>
    {% load essarch_meta %}
    {% load tags_meta %}
    {% load i18n %}
    {% load tz %}
<ead audience="internal" xmlns="urn:isbn:1-931666-22-9" xmlns:xlink="http://www.w3.org/1999/xlink"
     xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
     xsi:schemaLocation="urn:isbn:1-931666-22-9 http://www.loc.gov/ead/ead.xsd">
    <eadheader countryencoding="iso3166-1" dateencoding="iso8601" langencoding="iso639-2b" repositoryencoding="iso15511">
        <eadid/>
        <filedesc>
            <titlestmt>
                <titleproper>{{ archive.name }}
                    <num>{{ archive.reference_code }}</num>
                </titleproper>
            </titlestmt>
        </filedesc>
        <profiledesc>
            <creation>This finding aid was produced using {% essarch_project_shortname %} version: {% essarch_version %}
                <date>{% now "Y-m-d G:i:s e" %}</date>
            </creation>
        </profiledesc>
    </eadheader>
    {% if archive.type|stringformat:"s" == 'Samling' or archive.type|stringformat:"s" == 'Collection' %}
    <archdesc level="collection">
    {% else %}
    <archdesc level="fonds">
        {% endif %}
        <did>
            <repository>
                <corpname><!-- GROUP/ORGANIZATION --></corpname>
            </repository>
            <unittitle encodinganalog="3.1.2">{{ archive.name }}</unittitle>
            {% for agent in agents %}
            {% if agent.type|stringformat:"s" == "arkivbildare" or agent.type|stringformat:"s" == "creator" %}
            <origination audience="internal" encodinganalog="3.2.1" label="Creator">
                {% if agent.agent.type.cpf == 'person' %}
                <persname source="local" id="essarch_{{agent.agent.id}}">{{agent_name.main}},{{agent_name.part}}</persname>
                {% elif agent.agent.type.cpf == 'family' %}
                <famname source="local" id="essarch_{{agent.agent.id}}">{{agent_name.main}}</famname>
                {% else %}
                <corpname source="local" id="essarch_{{agent.agent.id}}">{{agent_name.main}}</corpname>
                {% endif %}
            </origination>
            {% endif %}
            {% endfor %}
            <unitid encodinganalog="3.1.1">{{ archive.reference_code }}</unitid>
            <unitdate>{{ archive.start_date|date:"Y" }}-{{ archive.end_date|date:"Y" }}</unitdate>
        </did>
        {% if archive.description %}
        <scopecontent encodinganalog="3.3.1"><p>{{ archive.description }}</p></scopecontent>
        {% endif %}
        {% for note in archive.notes.all %}
        {% if note.type.history %}
        <custodhist>
            <p>{{note.text}}</p>
        </custodhist>
        {% endif %}
        {% endfor %}
        {% for note in archive.notes.all %}
        {% if not note.type.history %}
        <processinfo>
            <p>{{ note.text }}</p>
        </processinfo>
        {% endif %}
        {% endfor %}
        <dsc>
            {% recursetree series node children %}
            {% if node.type|lower|stringformat:"s" not in 'class, collection, file, fonds, item, recordgrp, series, subfonds, subgrp, subseries' %}
            <c audience="internal" id="essarch_{{node.pk}}" level="otherlevel" otherlevel="{{node.type}}">
            {% else %}
            <c audience="internal" id="essarch_{{node.pk}}" level="{{node.type}}">
                {% endif %}
                <did>
                    <unittitle>{{ node.name }}</unittitle>
                    <unitid>{{ node.reference_code }}</unitid>
                    {% if node.start_date or node.end_date %}
                    <unitdate>{{ node.start_date | date:"Y" }} -- {{ node.end_date | date:"Y" }}</unitdate>
                    {% endif %}
                </did>
                {% if node.description %}
                <odd>
                    <p>{{ node.description }}</p>
                </odd>
                {% endif %}
                {% if not node.is_leaf_node %}
                {{ children }}
                {% else %}
                {% if node.tagstructure_set.exists %}
                {% recursetree node.tagstructure_set.first.get_root.get_descendants b_node b_children %}
                <c audience="internal" id="essarch_{{b_node.pk}}" level="otherlevel" otherlevel="{{b_node.tag.current_version.type}}">
                      <did>
                    <unittitle>{{ b_node.tag.current_version.name }}</unittitle>
                    <unitid>{{ b_node.tag.current_version.reference_code }}</unitid>
                    {% if b_node.tag.current_version.start_date or b_node.tag.current_version.end_date %}
                    <unitdate>{{ b_node.tag.current_version.start_date | date:"Y" }} -- {{ b_node.tag.current_version.end_date | date:"Y" }}</unitdate>
                    {% endif %}
                </did>
                      {% if b_node.tag.current_version.description %}
                <odd>
                    <p>{{ b_node.tag.current_version.description }}</p>
                </odd>
                {% endif %}
                    {% if not b_node.is_leaf_node %}
                    {{ b_children }}
                    {% else %}
                    {% endif %}
                </c>
                {% endrecursetree %}
                {% endif %}
                {% endif %}
            </c>
            {% endrecursetree %}
        </dsc>
    </archdesc>
</ead>
{% endspaceless %}
